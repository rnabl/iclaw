/**
 * Business Discovery Workflow
 * 
 * Calls APIFY Google Places scraper + website scanner enrichment.
 * Returns complete business data with signals (SEO, ads, chatbot, booking, etc.)
 */

import type { StepContext } from '../execution/runner';
import { runner } from '../execution/runner';
import { z } from 'zod';
import { scanWebsite, type WebsiteScanResult } from '../scanners/website-scanner';

const BusinessDiscoveryInput = z.object({
  niche: z.string(),
  location: z.string(),
  limit: z.coerce.number().default(100),
  enrich: z.coerce.boolean().default(true),
});

type BusinessDiscoveryInput = z.infer<typeof BusinessDiscoveryInput>;

interface BusinessSignals {
  // Website presence
  hasWebsite: boolean;
  websiteAccessible: boolean;
  
  // SEO signals
  seoOptimized: boolean;
  hasSSL: boolean;
  hasMetaDescription: boolean;
  hasStructuredData: boolean;
  
  // Advertising
  hasAds: boolean;
  hasFacebookPixel: boolean;
  hasGoogleAnalytics: boolean;
  hasGoogleTagManager: boolean;
  
  // Social presence
  hasSocials: boolean;
  socialPlatforms: string[];
  
  // Booking
  hasBooking: boolean;
  bookingPlatforms: string[];
  
  // Chatbot
  hasChatbot: boolean;
  chatbotPlatforms: string[];
  
  // AI Readability
  aiReadable: boolean;
  aiReadabilityScore: number;
  
  // Tech stack
  techStack: {
    cms?: string;
    hasWordPress: boolean;
    hasShopify: boolean;
    hasWix: boolean;
  };
  
  // Trust signals from Google
  reviewCount: number | null;
  averageRating: number | null;
  reviewCountBand: 'none' | 'few' | 'some' | 'many';
  reviewRatingBand: 'none' | 'low' | 'medium' | 'high' | null;
}

interface EnrichedBusiness {
  name: string;
  phone: string | null;
  website: string | null;
  address: string | null;
  city: string | null;
  state: string | null;
  zipCode: string | null;
  rating: number | null;
  reviewCount: number | null;
  placeId: string | null;
  googlePlaceId: string | null;
  category: string | null;
  googleMapsUrl: string | null;
  latitude: number | null;
  longitude: number | null;
  imageUrl: string | null;
  // Enrichment
  signals: BusinessSignals;
  enriched: boolean;
}

interface BusinessDiscoveryOutput extends Record<string, unknown> {
  businesses: EnrichedBusiness[];
  totalFound: number;
  searchTimeMs: number;
  enrichmentTimeMs: number;
  source: string;
  niche: string;
  location: string;
  stats: {
    total: number;
    withWebsites: number;
    enriched: number;
    withAds: number;
    withBooking: number;
    withChatbot: number;
    seoOptimized: number;
    aiReadable: number;
  };
}

function transformScanToSignals(scan: WebsiteScanResult, business: { rating: number | null; reviewCount: number | null }): BusinessSignals {
  const socialPlatforms: string[] = [];
  if (scan.social.facebook) socialPlatforms.push('facebook');
  if (scan.social.instagram) socialPlatforms.push('instagram');
  if (scan.social.twitter) socialPlatforms.push('twitter');
  if (scan.social.linkedin) socialPlatforms.push('linkedin');
  if (scan.social.youtube) socialPlatforms.push('youtube');
  if (scan.social.tiktok) socialPlatforms.push('tiktok');
  
  const seoScore = [
    scan.hasSSL,
    scan.hasMetaDescription,
    scan.hasH1,
    scan.hasStructuredData,
    scan.hasOpenGraph,
  ].filter(Boolean).length;
  
  return {
    hasWebsite: true,
    websiteAccessible: scan.accessible,
    
    seoOptimized: seoScore >= 3,
    hasSSL: scan.hasSSL,
    hasMetaDescription: scan.hasMetaDescription,
    hasStructuredData: scan.hasStructuredData,
    
    hasAds: scan.pixels.hasFacebookPixel || scan.pixels.hasGoogleAnalytics,
    hasFacebookPixel: scan.pixels.hasFacebookPixel,
    hasGoogleAnalytics: scan.pixels.hasGoogleAnalytics,
    hasGoogleTagManager: scan.pixels.hasGoogleTagManager,
    
    hasSocials: scan.hasSocialLinks,
    socialPlatforms,
    
    hasBooking: scan.booking.hasBookingSystem,
    bookingPlatforms: scan.booking.bookingPlatforms,
    
    hasChatbot: scan.chatbot.hasChatbot,
    chatbotPlatforms: scan.chatbot.chatbotPlatforms,
    
    aiReadable: scan.aiReadable,
    aiReadabilityScore: scan.aiReadabilityScore,
    
    techStack: {
      cms: scan.tech.cms,
      hasWordPress: scan.tech.hasWordPress,
      hasShopify: scan.tech.hasShopify,
      hasWix: scan.tech.hasWix,
    },
    
    reviewCount: business.reviewCount,
    averageRating: business.rating,
    reviewCountBand: business.reviewCount 
      ? (business.reviewCount >= 100 ? 'many' : business.reviewCount >= 20 ? 'some' : business.reviewCount >= 1 ? 'few' : 'none')
      : 'none',
    reviewRatingBand: business.rating
      ? (business.rating >= 4.5 ? 'high' : business.rating >= 4.0 ? 'medium' : business.rating >= 3.0 ? 'low' : 'none')
      : null,
  };
}

function getDefaultSignals(business: { rating: number | null; reviewCount: number | null; website: string | null }): BusinessSignals {
  return {
    hasWebsite: !!business.website,
    websiteAccessible: false,
    seoOptimized: false,
    hasSSL: false,
    hasMetaDescription: false,
    hasStructuredData: false,
    hasAds: false,
    hasFacebookPixel: false,
    hasGoogleAnalytics: false,
    hasGoogleTagManager: false,
    hasSocials: false,
    socialPlatforms: [],
    hasBooking: false,
    bookingPlatforms: [],
    hasChatbot: false,
    chatbotPlatforms: [],
    aiReadable: false,
    aiReadabilityScore: 0,
    techStack: { hasWordPress: false, hasShopify: false, hasWix: false },
    reviewCount: business.reviewCount,
    averageRating: business.rating,
    reviewCountBand: business.reviewCount 
      ? (business.reviewCount >= 100 ? 'many' : business.reviewCount >= 20 ? 'some' : business.reviewCount >= 1 ? 'few' : 'none')
      : 'none',
    reviewRatingBand: business.rating
      ? (business.rating >= 4.5 ? 'high' : business.rating >= 4.0 ? 'medium' : business.rating >= 3.0 ? 'low' : 'none')
      : null,
  };
}

async function businessDiscoveryHandler(
  ctx: StepContext,
  input: Record<string, unknown>
): Promise<BusinessDiscoveryOutput> {
  const params = BusinessDiscoveryInput.parse(input);
  const { niche, location, limit, enrich } = params;
  
  const startTime = Date.now();
  
  await ctx.log('info', `Starting discovery: ${niche} in ${location}`, { limit, enrich });
  
  // STEP 1: Call APIFY
  const { searchBusinesses } = await import('../providers/apify/google-places');
  
  const locationParts = location.split(',').map(s => s.trim());
  const city = locationParts[0] || location;
  const state = locationParts[1] || '';
  
  await ctx.log('info', `Calling APIFY: city="${city}", state="${state}", query="${niche}"`);
  
  const results = await searchBusinesses({
    query: niche,
    city,
    state,
    maxResults: limit,
  });
  
  await ctx.log('info', `APIFY returned ${results.length} businesses`);
  ctx.recordApiCall('apify', 'google_maps_scraper', results.length);
  
  // Deduplicate
  const seen = new Set<string>();
  const uniqueResults = results.filter(r => {
    const id = r.googlePlaceId || r.name;
    if (seen.has(id)) return false;
    seen.add(id);
    return true;
  });
  
  const apifyTime = Date.now() - startTime;
  
  // STEP 2: Enrich with website scanner (FREE - just HTTP fetches)
  const enrichStartTime = Date.now();
  const businessesWithWebsites = uniqueResults.filter(b => b.website);
  
  let scanResults: Map<string, WebsiteScanResult> = new Map();
  
  if (enrich && businessesWithWebsites.length > 0) {
    await ctx.log('info', `Enriching ${businessesWithWebsites.length} businesses with website scanner...`);
    
    // Scan in parallel with timeout
    const SCAN_TIMEOUT = 8000;
    const MAX_CONCURRENT = 10;
    
    const batches: typeof businessesWithWebsites[] = [];
    for (let i = 0; i < businessesWithWebsites.length; i += MAX_CONCURRENT) {
      batches.push(businessesWithWebsites.slice(i, i + MAX_CONCURRENT));
    }
    
    for (const batch of batches) {
      const batchResults = await Promise.allSettled(
        batch.map(async (b) => {
          const scan = await scanWebsite(b.website!, SCAN_TIMEOUT);
          return { website: b.website!, scan };
        })
      );
      
      for (const result of batchResults) {
        if (result.status === 'fulfilled') {
          scanResults.set(result.value.website, result.value.scan);
        }
      }
    }
    
    await ctx.log('info', `Scanned ${scanResults.size}/${businessesWithWebsites.length} websites`);
  }
  
  const enrichmentTimeMs = Date.now() - enrichStartTime;
  
  // STEP 3: Build enriched output
  const businesses: EnrichedBusiness[] = uniqueResults.map(r => {
    const scan = r.website ? scanResults.get(r.website) : undefined;
    const signals = scan 
      ? transformScanToSignals(scan, { rating: r.rating, reviewCount: r.reviewCount })
      : getDefaultSignals({ rating: r.rating, reviewCount: r.reviewCount, website: r.website });
    
    return {
      name: r.name,
      phone: r.phone,
      website: r.website,
      address: r.address,
      city: r.city,
      state: r.state,
      zipCode: r.zipCode,
      rating: r.rating,
      reviewCount: r.reviewCount,
      placeId: r.googlePlaceId,
      googlePlaceId: r.googlePlaceId,
      category: r.category,
      googleMapsUrl: r.googleMapsUrl,
      latitude: r.latitude,
      longitude: r.longitude,
      imageUrl: r.imageUrl,
      signals,
      enriched: !!scan,
    };
  });
  
  // Calculate stats
  const stats = {
    total: businesses.length,
    withWebsites: businesses.filter(b => b.website).length,
    enriched: businesses.filter(b => b.enriched).length,
    withAds: businesses.filter(b => b.signals.hasAds).length,
    withBooking: businesses.filter(b => b.signals.hasBooking).length,
    withChatbot: businesses.filter(b => b.signals.hasChatbot).length,
    seoOptimized: businesses.filter(b => b.signals.seoOptimized).length,
    aiReadable: businesses.filter(b => b.signals.aiReadable).length,
  };
  
  const searchTimeMs = Date.now() - startTime;
  
  await ctx.log('info', `Discovery complete: ${businesses.length} businesses, ${stats.enriched} enriched in ${searchTimeMs}ms`);
  await ctx.log('info', `Stats: ${stats.withAds} with ads, ${stats.withBooking} with booking, ${stats.withChatbot} with chatbot`);
  
  // Build formatted response for chat display
  const formattedResponse = formatDiscoveryForChat(businesses, stats, niche, location, searchTimeMs);
  
  return {
    businesses,
    totalFound: businesses.length,
    searchTimeMs,
    enrichmentTimeMs,
    source: 'harness-apify',
    niche,
    location,
    stats,
    formattedResponse,
  };
}

function formatDiscoveryForChat(
  businesses: EnrichedBusiness[],
  stats: BusinessDiscoveryOutput['stats'],
  niche: string,
  location: string,
  searchTimeMs: number
): string {
  const ratings = businesses.filter(b => b.rating).map(b => b.rating!);
  const avgRating = ratings.length > 0 
    ? (ratings.reduce((a, b) => a + b, 0) / ratings.length).toFixed(1) 
    : 'N/A';
  const withPhone = businesses.filter(b => b.phone).length;
  
  let msg = `## üî• Found ${stats.total} ${niche} in ${location}\n\n`;
  msg += `| Metric | Value |\n|--------|-------|\n`;
  msg += `| ‚è±Ô∏è Search Time | ${(searchTimeMs / 1000).toFixed(1)}s |\n`;
  msg += `| ‚≠ê Avg Rating | ${avgRating} |\n`;
  msg += `| üåê With Website | ${stats.withWebsites}/${stats.total} |\n`;
  msg += `| üìû With Phone | ${withPhone}/${stats.total} |\n`;
  msg += `| üìä Enriched | ${stats.enriched} |\n`;
  msg += `| üìà Running Ads | ${stats.withAds} |\n`;
  msg += `| üìÖ Has Booking | ${stats.withBooking} |\n`;
  msg += `| ü§ñ Has Chatbot | ${stats.withChatbot} |\n\n`;
  
  msg += `### Results\n\n`;
  msg += `| # | Business | ‚≠ê | Phone | SEO | Ads | Book | Bot |\n`;
  msg += `|---|----------|-----|-------|-----|-----|------|-----|\n`;
  
  const displayCount = Math.min(15, businesses.length);
  for (let i = 0; i < displayCount; i++) {
    const b = businesses[i];
    const num = i + 1;
    const name = b.name.length > 28 ? b.name.substring(0, 25) + '...' : b.name;
    const rating = b.rating ? b.rating.toFixed(1) : 'N/A';
    const phone = b.phone ? b.phone.replace(/[^\d]/g, '').slice(-10) : '';
    const phoneFormatted = phone.length === 10 
      ? `(${phone.slice(0,3)}) ${phone.slice(3,6)}-${phone.slice(6,10)}`
      : '‚Äî';
    
    const seo = b.signals.seoOptimized ? '‚úÖ' : '‚ùå';
    const ads = b.signals.hasAds ? '‚úÖ' : '‚ùå';
    const cal = b.signals.hasBooking ? '‚úÖ' : '‚ùå';
    const bot = b.signals.hasChatbot ? '‚úÖ' : '‚ùå';
    
    msg += `| ${num} | ${name} | ${rating} | ${phoneFormatted} | ${seo} | ${ads} | ${cal} | ${bot} |\n`;
  }
  
  if (businesses.length > displayCount) {
    msg += `\n*+ ${businesses.length - displayCount} more businesses available*\n`;
  }
  
  msg += `\n### Legend\n`;
  msg += `- **SEO** = Website optimized (SSL, meta, structured data)\n`;
  msg += `- **Ads** = Running Facebook/Google pixels\n`;
  msg += `- **Book** = Has online booking system\n`;
  msg += `- **Bot** = Has chatbot installed\n`;
  
  msg += `\n### Actions\n`;
  msg += `- \`enrich <#>\` ‚Äî Get owner info & deep signals\n`;
  msg += `- \`details <#>\` ‚Äî Full business profile\n`;
  msg += `- \`export\` ‚Äî Download as CSV\n`;
  
  return msg;
}

runner.registerWorkflow('discover-businesses', businessDiscoveryHandler);

export { businessDiscoveryHandler };
